@model WasySender_2_0.Models.GetOperationsNew
@using WasySender_2_0.Models
@using WasySender_2_0.Models;
@using Newtonsoft.Json;

@{
    ViewBag.Title = "Dettaglio Lotto";

    Users u = new Users();
    u = JsonConvert.DeserializeObject<Users>(Request.Cookies["login"].Value);

}
<style>
    .rr{
        width:100px;
    }

    .tbl-responsive {
        width: 100%;
    }

        .tbl-responsive th {
            background: #476bab;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            height: 40px !important;
            padding: 0 10px;
            border-right: 1px solid #fff;
            min-width: 80px;
        }

        .tbl-responsive td {
            height: 80px;
            padding: 5px 10px;
            border-right: 1px solid #e1e1e1;
            border-bottom: 1px solid #e1e1e1;
            text-align: left;
            font-weight: 600;
            min-width: 80px;
        }

            .tbl-responsive td:first-child {
                border-left: 1px solid #e1e1e1;
            }

        .tbl-responsive tr:nth-child(2n+1) {
            background: #fafafa;
        }

    .empty-td {
        width: 100%;
        text-align: center !important;
        padding: 30px 0;
    }

</style>

<div class="col-lg-12">
    <div class="content-breadcrumb">DASHBOARD / STATO SPEDIZIONI / CORRISPONDENZA / LOTTO</div>
</div>


<div class="default-page">
    <div class="col-lg-12">
        <div class="row">
            <div class="col-lg-8 col-md-8">
                <section>
                    <div class="row">
                        <div class="col-lg-12">
                            <h1>DETTAGLIO LOTTO</h1>
                        </div>
                        <div @if (Model.type == (int)operationType.MOL || Model.type == (int)operationType.COL || u.hidePrice) { <text> class="col-lg-12" </text>  } else { <text> class="col-lg-6" </text> }>
                            <div class="report-lotto">
                                <ul>
                                    <li>CODICE SPEDIZIONE</li>
                                    <li><span>COD.@Model.operationId</span></li>
                                </ul>
                                <ul>
                                    <li>PRODOTTO POSTALE</li>
                                    <li><span>@Model.operationType</span></li>
                                </ul>
                                <ul>
                                    <li>NUMERO DI DESTINATARI</li>
                                    <li><span>@Model.recipients.Where(a => a.recipient.valid == true).Count()</span></li>
                                </ul>
                                <ul>
                                    <li>DATA DI CREAZIONE</li>
                                    <li><span>@Model.operationDate.ToString("dd/MM/yyyy HH:mm:ss")</span></li>
                                </ul>
                                @if (!u.hidePrice) 
                                { 
                                    <ul>
                                        <li>DISTINTA DI SPEDIZIONE</li>
                                        <li><img src="~/Images/IcnDownload.png" /> <a href="/Corrispondenza/ExportPDF/@Model.operationId">Scarica la distinta</a> </li>
                                    </ul>
                                }
                            </div>
                        </div>
                        <div class="col-lg-6 @if (Model.type == (int)operationType.MOL || Model.type == (int)operationType.COL || u.hidePrice) { <text> hidden </text> }">
                            <div class="row">
                                <div class="col-lg-12">
                                    <h1>PREZZO LOTTO</h1>
                                </div>
                            </div>
                            <div class="costi-lotto">
                                <ul>
                                    <li>PREZZO NETTO</li>
                                    <li><span>€ @Model.price</span></li>
                                </ul>
                                <ul>
                                    <li>IVA 22%</li>
                                    <li><span>€ @Model.vatPrice</span></li>
                                </ul>
                                <ul>
                                    <li>COSTO TOTALE</li>
                                    <li><label>€ @Model.totalPrice</label></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="col-lg-4 col-md-4">
                <section>
                    <div class="cerca-lotto">
                        <h1>RICERCA SPEDIZIONE</h1>
                        <ul>
                            <li>
                                <input type="text" name="destinatario" placeholder="Destinatario" class="username" />
                            </li>
                            <li>
                                <input type="text" name="codice" placeholder="Codice" class="code" />
                            </li>
                            <li>
                                <select name="esito" class="esito">
                                    <option value="">Esito</option>
                                    <option value="true">OK</option>
                                    <option value="false">ERRORE</option>
                                </select>
                            </li>
                            <li>
                                <input type="submit" name="search" value="CERCA" onclick="ApplyFilter()" />
                            </li>
                        </ul>
                    </div>
                </section>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <section>
                    <div class="wait"><img src="/Images/preload.gif">attendere creazione file zip</div>
                    @if (u.GED && Model.type == (int)operationType.ROL)
                    {
                        <div class="download-doc-zip doc-zip-rr" style="margin-left:30px"><i class="fas fa-file-archive"></i> &nbsp;scarica tutti le R.R.</div>
                    }
                    @if (u.downloadFile)
                    {
                        <div class="download-doc-zip doc-zip"><i class="fas fa-file-archive"></i> &nbsp;scarica tutti i documenti</div>
                    }
                    <div class="content-table-responsive">
                        <div class="stato-sped-grid-lotto">
                            <table class="tbl-responsive">
                                <thead>
                                    <tr>
                                        <th>
                                            NOMINATIVO
                                        </th>
                                        <th>
                                            INDIRIZZO
                                        </th>
                                        <th>
                                            ESITO TRASFERIMENTO
                                        </th>
                                        <th>
                                            DATA ACCETTAZIONE
                                        </th>
                                        <th>
                                            CODICE
                                            @if (Model.type == (int)operationType.ROL)
                                            {<text>RACCOMANDATA</text>}
                                        </th>
                                        <th>
                                            STATO
                                        </th>
                                        @if (Model.type != (int)operationType.TELEGRAMMA && u.downloadFile)
                                        {
                                            <th>
                                                DOWN. DOC.
                                            </th>
                                        }
                                        @if (u.GED && Model.type == (int)operationType.ROL)
                                        {
                                            <th>R.R.</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody class="names">
                                    @foreach (var r in Model.recipients)
                                    {
                                        var cod = r.bulletin != null ? " <br>cod: " + r.bulletin.CodiceCliente + (r.bulletin.Pagato == true ? "<br><span style='color:green'>PAGATO</span>" : "<br><span style='color:red'>NON PAGATO</span>") : "";
                                        <tr>
                                            <td>@r.recipient.businessName @r.recipient.name @r.recipient.surname @Html.Raw(cod)</td>
                                            <td>@r.recipient.dug @r.recipient.address @r.recipient.houseNumber<br />@r.recipient.cap @r.recipient.city (@r.recipient.province)</td>
                                            <td>@(r.recipient.valid == true ? EnumHelper<CurrentState>.GetDisplayValue((CurrentState)r.recipient.currentState) : "RIFIUTATO")</td>
                                            <td>@r.recipient.insertDate.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                            <td><a onclick="OpenPopup('@r.recipient.requestId')">@r.recipient.codice</a></td>
                                            <td id="@r.recipient.requestId" class="status" title="@r.recipient.orderId">
                                                @if (r.recipient.valid == true)
                                                {
                                                    if (r.recipient.state == null)
                                                    {
                                                        <text>Non ancora lavorato</text>
                                                    }
                                                    else
                                                    {
                                                        if (Model.type != (int)operationType.LOL && Model.type != (int)operationType.TELEGRAMMA)
                                                        {
                                                            <text>
                                                                <a href="https://www.poste.it/cerca/index.html#/risultati-spedizioni/@r.recipient.codice" target="_blank" title="verifica lo stato sul sito di poste">
                                                                    @r.recipient.stato
                                                                </a>
                                                            </text>
                                                        }
                                                        else
                                                        {
                                                            <text>@r.recipient.stato</text>
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    @r.recipient.stato.Replace("Postel", "")
                                                }
                                            </td>
                                            @if (Model.type != (int)operationType.TELEGRAMMA && u.downloadFile)
                                            {
                                                if ((r.recipient.orderId == null || r.recipient.orderId == "") && (r.recipient.codice == null || r.recipient.codice == ""))
                                                {
                                                    <text>
                                                        <td>Non disponibile</td>
                                                    </text>
                                                }
                                                else
                                                {
                                                    <text>
                                                        <td><a onclick="GetPdf(@r.recipient.id)"><img src="/Images/IcnDownload.png" /></a></td>
                                                    </text>
                                                }
                                            }

                                            @if (u.GED && Model.type == (int)operationType.ROL)
                                            {
                                                if (r.recipient.codice == null || r.recipient.codice == "")
                                                {
                                                    <text>
                                                        <td>Non disp.</td>
                                                    </text>
                                                }
                                                else
                                                {
                                                    <text>
                                                        <td><a onclick="GetPdfGED(@r.recipient.id)"><img src="/Images/IcnDownload.png" /></a></td>
                                                    </text>
                                                }
                                            }

                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<div class="popup-std">
    <div class="col-lg-12">
        <div class="close-popup wowload delay-02 fadeIn">
            <a onclick="ClosePopup()" title="Chiudi Dettaglio"><img src="~/Images/IcnClose.png" /></a>
        </div>
    </div>
    <div class="col-lg-4 col-lg-offset-4 col-md-4 col-md-offset-4">
        <div class="content-popup">
            <div class="row">
                <div class="col-lg-12">
                    <section>
                        <h3>INFORMATIVA SU SPEDIZIONE</h3>
                        <div class="info-sped-popup">
                            <ul>
                                <li>NOME CLIENTE</li>
                                <li><span>@ViewBag.userName</span></li>
                            </ul>
                            <ul>
                                <li>CODICE SPEDIZIONE</li>
                                <li><span class="cod"></span></li>
                            </ul>
                            <ul>
                                <li>DESTINATARIO</li>
                                <li><span class="dest"></span></li>
                            </ul>
                        </div>
                    </section>
                    <section>
                        <div class="dettaglio-sped-popup">
                            <ul>
                                <li class="top-grid">DATA E ORA</li>
                                <li class="top-grid">STATO LAVORAZIONE</li>
                            </ul>
                            <ul>
                                <li class="dataCar">-</li>
                                <li>CARICAMENTO SUL PORTALE</li>
                            </ul>
                            <ul>
                                <li class="dataPre">-</li>
                                <li>PRESA IN CARICO</li>
                            </ul>
                            <ul>
                                <li class="dataCo">-</li>
                                <li>CONSEGNA</li>
                            </ul>
                        </div>
                    </section>
                </div>
                <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 hidden">
                    <div class="download-det-sped">
                        <img src="~/Images/IcnDownloadSped.png" /> SCARICA LA DISTINTA DI SPEDIZIONE
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var guiduser = '@ViewBag.guiduser';
    var operationId = '@Model.operationId';
    var areaTestUser = '@u.areaTestUser';
    var type = '@Model.type';
    var downloadFile = @Model.type != 3 ? '@u.downloadFile' : 'False';
    var GED = '@u.GED';



    function GetPdf(id) {
        $.get("/Corrispondenza/GetPdf/" + id, function (result) {
            if (result !== "")
                window.open(result, "document");
            else
                alert("Documento non disponibile");
            return false;
        });
    }

    function GetPdfGED(id) {
        $.get("/Corrispondenza/GetPdfGED/" + id, function (result) {
            if (result !== "")
                window.open(result, "document");
            else
                alert("Documento non disponibile");
            return false;
        });
    }

    $(function () {
        //GetStatus();
        $('.doc-zip').on('click', function () {
            $(this).attr('target', '_blank');
            createZIP(operationId);
        });
        //GetStatus();
        $('.doc-zip-rr').on('click', function () {
            $(this).attr('target', '_blank');
            createZIPRR(operationId);
        });
    });

    function ApplyFilter() {
        var usrname = "";
        var code = "";
        var esito = "";
        if ($('.username').val() !== "") {
            usrname = "&username=" + $('.username').val();
        };
        if ($('.code').val() !== "") {
            code = "&code=" + $('.code').val();
        };
        if ($('.esito').val() !== "") {
            esito = "&esito=" + $('.esito').val();
        };

        $.getJSON("/Scripts/api/configuration.json", function (c) {
            $.get(c.apiurl + "/Operations/Items/" + operationId + "?guidUser=" + guiduser + usrname + code + esito, function (r) {
                $('.names').empty();
                $.each(r.recipients, function (k, v) {
                    var cod = v.bulletin != null ? " <br>cod: " + v.bulletin.codiceCliente : "";

                    var ul = "<ul>" +
                        "<li>" + v.recipient.businessName + " " + v.recipient.name + " " + v.recipient.surname + " " + cod + "</li>" +
                        "<li>" + v.recipient.dug + " " + v.recipient.address + " " + v.recipient.houseNumber + ", " + v.recipient.cap + "</li>" +
                        "<li>" + v.recipient.city + " (" + v.recipient.province + ")</li>" +
                        "<li>" + (v.recipient.valid ? "Accettato" : "ERRORE") + "</li>" +
                        "<li>" + new Date(v.recipient.presaInCaricoDate).toLocaleDateString() + " " + new Date(v.recipient.presaInCaricoDate).toLocaleTimeString() + "</li>" +
                        "<li>" + v.recipient.codice + "</li>";
                    ul += "<li id='" + v.recipient.requestId + "'>";

                    if (type != 2)
                        ul += "<a href='https://www.poste.it/cerca/index.html#/risultati-spedizioni/" + v.recipient.codice + "' target='_blank' title='verifica lo stato sul sito di poste'>" + v.recipient.stato + "</a>";
                    else
                        ul += v.recipient.stato;

                    ul += "</li>";

                    @if (u.downloadFile) {
                        <Text>
                        if (downloadFile == "True") {
                            ul += "<li><a onclick='GetPdf(" + v.recipient.id + ")'><img src='/Images/IcnDownload.png' /></a></li>"
                        };
                        if (downloadFile != "True") {
                            ul += "<li>Non disponibile</li>";
                        };
                        </Text>
                     }
                     @if (u.GED) {
                         <Text>
                         ul += "<li><a onclick='GetPdfGED(" + v.recipient.id + ")'><img src='/Images/IcnDownload.png' /></a></li>";
                        </Text>
                     }

                    ul += "</ul>";
                    $('.names').append(ul);
                });
                //GetStatus();
            });
        });
    }

    function OpenPopup(requestId) {
        $.getJSON("/Scripts/api/configuration.json", function (c) {
            $.get(c.apiurl + "/Names/Item?guidUser=" + guiduser + "&requestId=" + requestId, function (r) {
                var data = "NON ANCORA CONSEGNATO";
                if (r.consegnatoDate !== null) { data = new Date(r.consegnatoDate).toLocaleString() };
                $('.cod').html(r.codice);
                $('.dest').html(r.businessName + " " + r.name + " " + r.surname);
                $('.dataCar').html(new Date(r.insertDate).toLocaleString());
                $('.dataPre').html(new Date(r.presaInCaricoDate).toLocaleString());
                $('.dataCo').html(data);
            });
        });
        $(".popup-std").fadeIn(300);
    }

    function createZIP(operationId) {
        $('.doc-zip').hide();
        $('.wait').show();

        $.get("/Corrispondenza/GetZIP/" + operationId, function (r) {
            var res = jQuery.parseJSON(r);
            if (res.success)
                document.location.href = "https://app.easysender.it/" + res.pathFile;
            else
                alert("Errore nella generazione del file ZIP.");

            $('.wait').hide();
            $('.doc-zip').show();
        });
    }

    function createZIPRR(operationId) {
        $('.doc-zip-rr').hide();
        $('.wait').show();

        $.get("/Corrispondenza/GetZIPRR/" + operationId, function (r) {
            var res = jQuery.parseJSON(r);
            if (res.success)
                document.location.href = "https://app.easysender.it/" + res.pathFile;
            else
                alert("Errore nella generazione del file ZIP.");

            $('.wait').hide();
            $('.doc-zip-rr').show();
        });
    }
</script>
